define(["exports","./../emby-apiclient/events.js","./../browser.js","./../htmlvideoplayer/htmlmediahelper.js","./../htmlvideoplayer/basehtmlplayer.js"],function(_exports,_events,_browser,_htmlmediahelper,_basehtmlplayer){var fadeTimeout,supportedFeatures;function cancelFadeTimeout(){fadeTimeout&&(clearTimeout(fadeTimeout),fadeTimeout=null)}function HtmlAudioPlayer(){var self=this;function unBindEvents(elem){elem.removeEventListener("timeupdate",onTimeUpdate),elem.removeEventListener("ended",onEnded),elem.removeEventListener("volumechange",onVolumeChange),elem.removeEventListener("ratechange",onRateChange),elem.removeEventListener("pause",onPause),elem.removeEventListener("playing",onPlaying),elem.removeEventListener("play",onPlay)}function bindMediaManager(elem){_browser.default.chromecast&&(cast.framework.CastReceiverContext.getInstance().getPlayerManager().setMediaElement(elem),self.bindMediaManagerEvents())}function onEnded(){_htmlmediahelper.default.onEndedInternal(self,this,onError)}function onTimeUpdate(){var time,currentPlayOptions;self._started&&!self._isFadingOut&&((time=this.currentTime)&&!self._timeUpdated&&(self._timeUpdated=!0),self._currentTime=time,(currentPlayOptions=self._currentPlayOptions)&&currentPlayOptions.transcodingOffsetTicks,_events.default.trigger(self,"timeupdate"))}function onVolumeChange(){self._isFadingOut||(_htmlmediahelper.default.saveVolume(this.volume),_events.default.trigger(self,"volumechange"))}function onRateChange(){_events.default.trigger(self,"playbackratechange")}function onPlaying(e){self._started||(self._started=!0,self.seekOnPlaybackStart(e.target,self._currentPlayOptions.playerStartPositionTicks)),_events.default.trigger(self,"playing")}function onPlay(e){_events.default.trigger(self,"unpause")}function onPause(){_events.default.trigger(self,"pause")}function onError(){var type,errorCode=this.error&&this.error.code||0,errorMessage=this.error&&this.error.message||"";switch(console.log("Media element error: "+errorCode.toString()+" "+errorMessage),errorCode){case 1:return;case 2:type="network";break;case 3:if(self._hlsPlayer)return void _htmlmediahelper.default.handleHlsJsMediaError(self);type="mediadecodeerror";break;case 4:type="medianotsupported";break;default:return}_htmlmediahelper.default.onErrorInternal(self,type)}_basehtmlplayer.default.call(this),this.name="Audio Player",self.id="htmlaudioplayer",self.mediaType="audio",self.priority=1,self.play=function(options){return self._started=!1,self._timeUpdated=!1,self._currentTime=null,function(elem,options){elem.removeEventListener("error",onError),unBindEvents(elem),function(elem){elem.addEventListener("timeupdate",onTimeUpdate),elem.addEventListener("ended",onEnded),elem.addEventListener("volumechange",onVolumeChange),elem.addEventListener("ratechange",onRateChange),elem.addEventListener("pause",onPause),elem.addEventListener("playing",onPlaying),elem.addEventListener("play",onPlay)}(elem);var val=options.url;console.log("playing url: "+val);var seconds=(options.playerStartPositionTicks||0)/1e7;seconds&&(val+="#t="+seconds);_htmlmediahelper.default.destroyHlsPlayer(self),self._currentPlayOptions=options;var crossOrigin=_htmlmediahelper.default.getCrossOriginValue(options.mediaSource,options.playMethod);crossOrigin&&(elem.crossOrigin=crossOrigin);return _browser.default.chromecast?self.setCurrentSrcChromecast(elem,options,val):self.loadIntoPlayer(elem,options,val)}(function(){var elem=self._mediaElement;if(elem)return bindMediaManager(elem),elem;(elem=document.querySelector(".mediaPlayerAudio"))||((elem=document.createElement("audio")).classList.add("mediaPlayerAudio"),elem.classList.add("hide"),document.body.appendChild(elem));return elem.volume=_htmlmediahelper.default.getSavedVolume(),bindMediaManager(self._mediaElement=elem),elem}(),options)},self.loadIntoPlayer=function(elem,options,val){return url=val,options.item,mediaSource=options.mediaSource,mediaType="Audio",(_htmlmediahelper.default.enableHlsJsPlayer(mediaSource.RunTimeTicks,mediaType)?-1!==url.indexOf(".m3u8")?Promise.resolve():fetch(url,{method:"HEAD"}).then(function(response){return"application/x-mpegurl"===(response.headers.get("Content-Type")||"").toLowerCase()?Promise.resolve():Promise.reject()}):Promise.reject()).then(function(){return self.setSrcWithHlsJs(elem,options,val,onError)},function(){return elem.autoplay=!0,_htmlmediahelper.default.applySrc(elem,val,options).then(function(){return self._currentSrc=val,_htmlmediahelper.default.playWithPromise(elem,onError)})});var url,mediaSource,mediaType},self.stop=function(destroyPlayer){cancelFadeTimeout();var elem=self._mediaElement,src=self._currentSrc;if(elem){if(!destroyPlayer||_browser.default.tizen||_browser.default.orsay||_browser.default.web0s||_browser.default.operaTv||_browser.default.netcast)return src&&elem.pause(),_htmlmediahelper.default.onEndedInternal(self,elem,onError),destroyPlayer&&self.destroy(),Promise.resolve();var originalVolume=elem.volume;return function fade(instance,elem,startingVolume){instance._isFadingOut=!0;var newVolume=Math.max(0,startingVolume-.15);return console.log("fading volume to "+newVolume),(elem.volume=newVolume)<=0?(instance._isFadingOut=!1,Promise.resolve()):new Promise(function(resolve,reject){cancelFadeTimeout(),fadeTimeout=setTimeout(function(){fade(instance,elem,newVolume).then(resolve,reject)},100)})}(self,elem,elem.volume).then(function(){elem.pause(),elem.volume=originalVolume,_htmlmediahelper.default.onEndedInternal(self,elem,onError),destroyPlayer&&self.destroy()})}return Promise.resolve()},self.destroy=function(){_browser.default.chromecast&&self.unBindMediaManagerEvents(),unBindEvents(self._mediaElement)}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_events=babelHelpers.interopRequireDefault(_events),_browser=babelHelpers.interopRequireDefault(_browser),_htmlmediahelper=babelHelpers.interopRequireDefault(_htmlmediahelper),_basehtmlplayer=babelHelpers.interopRequireDefault(_basehtmlplayer),Object.assign(HtmlAudioPlayer.prototype,_basehtmlplayer.default.prototype),HtmlAudioPlayer.prototype.supports=function(feature){var list;return supportedFeatures||(list=[],_browser.default.tizen||list.push("SetPlaybackRate"),supportedFeatures=list),-1!==supportedFeatures.indexOf(feature)},HtmlAudioPlayer.prototype.destroy=function(){},_exports.default=HtmlAudioPlayer});