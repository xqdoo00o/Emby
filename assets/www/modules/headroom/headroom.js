define(["dom","layoutManager","apphost","events","css!./headroom"],function(dom,layoutManager,appHost,events){"use strict";function Headroom(options){options=options||{},this.lastScrollY=0,this.lastTransformScrollY=0,this.element=options.element,this.scrollElementForEvents=options.scroller||window,this.scroller=this.scrollElementForEvents,this.offset=options.offset}var headerHeight,headerElement;var supportsCssEnv=function(){if("android"===self.appMode)return!0;try{var val=getComputedStyle(document.documentElement).getPropertyValue("--env-inset-top");if(val&&!val.includes("env("))return!0}catch(err){}return!1}();!function(){try{document.documentElement.style.setProperty("--env-inset-top","1")}catch(err){}}();var topCalc="android"===self.appMode?"translateY(calc(-100% + var(--window-inset-top, 0)))":"translateY(calc(-100% + env(safe-area-inset-top, 0)))",allowAnimation=!!CSS.supports("transform","scale(1)")&&(!((navigator.hardwareConcurrency||4)<4)&&!((navigator.deviceMemory||2)<1));return Headroom.prototype={constructor:Headroom,init:function(){return this.active=!1,allowAnimation&&this.attachEvent(),this},pause:function(){this.paused=!0},beginResume:function(){this.paused&&this.allowBeginResume&&(this.paused=!1,allowAnimation&&this.updateFn(null,!0,!0,!0))},resume:function(){this.paused&&(this.paused=!1,allowAnimation&&this.updateFn(null,!0,!0,!1))},destroy:function(){this.lastScrollY=null,this.lastTransformScrollY=null;var scroller=this.scrollElementForEvents;scroller&&(scroller.removeScrollEventListener?scroller.removeScrollEventListener(this.updateFn,{capture:!1,passive:!0}):dom.removeEventListener(scroller,"scroll",this.updateFn,{capture:!1,passive:!0})),this.scrollElementForEvents=null,this.scroller=null,this.element=null},attachEvent:function(){var isNativeScroll=this.scroller.isNativeScroll();this.isNativeScroll=isNativeScroll,this.updateFn=isNativeScroll?this.updateWithRequestAnimationFrame.bind(this):this.update.bind(this),this.lastScrollY=this.scroller.getScrollPosition(),this.allowBeginResume=!isNativeScroll,this.lastTransformScrollY=this.lastScrollY;var scroller=this.scrollElementForEvents;scroller&&(scroller.addScrollEventListener?scroller.addScrollEventListener(this.updateFn,{capture:!1,passive:!0}):dom.addEventListener(scroller,"scroll",this.updateFn,{capture:!1,passive:!0})),this.updateFn(null,!0,!1)},setTransform:function(value,top,forceRefresh,immediate){var elem,isActive,classList;!forceRefresh&&value===this.transform||(elem=this.element)&&value!==elem.headroomTransform&&(this.transform=value,0===(elem.headroomTransform=value)?value="none":isActive=(value=1===value?supportsCssEnv?topCalc:"translateY(-100%)":"translateY(-"+value+"px)",!0),classList=elem.classList,this.active===isActive&&!forceRefresh||((this.active=isActive)?classList.add("headroom-active"):classList.remove("headroom-active")),immediate?function(elem,classList,value){classList.add("headroom-notransition"),elem.style.transform=value,elem.offsetWidth,classList.remove("headroom-notransition")}(elem,classList,value):this.isNativeScroll?elem.style.transform=value:immediate||this.setTransformWithAnimationFrame(elem,value))},setTransformWithAnimationFrame:function(elem,value){requestAnimationFrame(function(){elem.style.transform=value})},update:function(e,forceRefresh,immediate,enableBackgroundSupport){var currentScrollY,lastScrollY,isTv,scrollingDirection,lastTransformScrollY,scrollThreshold,top,toleranceExceeded,previousTransform,newValue;this.paused||(!enableBackgroundSupport||this.allowBeginResume?currentScrollY=this.scroller.getScrollPosition():null==(currentScrollY=this.scroller.getLastScrollPosition())&&(currentScrollY=this.lastScrollY||0),currentScrollY<0||(lastScrollY=this.lastScrollY,isTv=layoutManager.tv,scrollingDirection=lastScrollY<currentScrollY?1:currentScrollY<lastScrollY?-1:0,(forceRefresh=!0===forceRefresh)&&(scrollingDirection=0),scrollThreshold=10,-1===scrollingDirection?(lastTransformScrollY=this.lastTransformScrollY,scrollThreshold=40):lastTransformScrollY=lastScrollY,top=currentScrollY<=(isTv?headerHeight=headerHeight||(headerElement||(headerElement=document.querySelector(".skinHeader"))).offsetHeight:0),toleranceExceeded=forceRefresh||Math.abs(currentScrollY-lastTransformScrollY)>scrollThreshold,1===scrollingDirection&&!top&&toleranceExceeded?(this.lastTransformScrollY=currentScrollY,this.setTransform(1,top,forceRefresh,immediate)):-1===scrollingDirection&&!isTv&&toleranceExceeded||top?(this.lastTransformScrollY=currentScrollY,this.setTransform(0,top,forceRefresh||top,immediate)):!scrollingDirection&&forceRefresh&&(this.lastTransformScrollY=currentScrollY,previousTransform=this.transform,newValue=top?0:null==previousTransform?1:previousTransform,this.setTransform(newValue,top,forceRefresh||top,immediate))),this.lastScrollY=currentScrollY)},updateWithRequestAnimationFrame:function(e,forceRefresh,immediate,enableBackgroundSupport){var instance=this;requestAnimationFrame(function(){instance.update(e,forceRefresh,immediate,enableBackgroundSupport)})}},Headroom});